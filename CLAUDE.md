# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

`gdu` (Go DiskUsage) is a fast disk usage analyzer written in Go, designed primarily for SSD disks with parallel processing support. It provides both an interactive TUI (Terminal User Interface) and non-interactive modes for disk usage analysis.

## Architecture

The codebase follows a modular architecture with clear separation of concerns:

- **cmd/gdu/** - Main entry point and CLI configuration using Cobra
- **pkg/** - Public packages providing core functionality:
  - `analyze/` - Disk usage analysis (parallel, sequential, storage-backed implementations)
  - `device/` - Device and filesystem information gathering
  - `fs/` - Filesystem abstractions and interfaces
  - `remove/` - File/directory deletion (background, parallel support)
- **tui/** - Terminal User Interface using tcell/tview
- **stdout/** - Non-interactive text output
- **report/** - JSON import/export functionality
- **internal/** - Internal packages and test utilities

### Key Design Patterns

**Parallel Processing**: The analyzer uses goroutines with concurrency limits (3Ã—GOMAXPROCS) for parallel directory traversal. See `pkg/analyze/parallel.go` for the implementation.

**Multiple Modes**: The application operates in three modes:
- Interactive (TUI) - default when TTY is detected
- Non-interactive - for scripts/automation
- Export mode - JSON output for later analysis

**Cross-platform**: Platform-specific implementations use build tags (e.g., `dir_linux.go`, `dir_unix.go`, `dir_other.go`).

## Common Commands

### Development

```bash
# Run the application
go run github.com/dundee/gdu/v5/cmd/gdu [path]

# Or use make target
make run
```

### Building

```bash
# Build for current platform
make build                    # Output: dist/gdu

# Build static binary
make build-static

# Build for all platforms
make build-all                # Requires gox: go install github.com/mitchellh/gox@latest

# Build Docker image
make build-docker             # Creates ghcr.io/dundee/gdu:$(VERSION)
```

### Testing

```bash
# Run all tests (uses gotestsum)
make test

# Run tests manually
go test -v ./...

# Run tests with coverage
make coverage                 # Generates coverage.txt

# View coverage in browser
make coverage-html

# Run benchmarks
make gobench                  # Benchmarks pkg/analyze
```

### Linting

```bash
# Run golangci-lint
make lint

# Install development dependencies (includes linters)
make install-dev-dependencies
```

### Profiling & Performance

```bash
# Run with profiling enabled
gdu --enable-profiling /path

# Access profiles at http://localhost:6060/debug/pprof/

# View heap profile
make heap-profile             # Opens browser with heap visualization

# Generate PGO (Profile-Guided Optimization) data
make pgo                      # Downloads and merges CPU profile into default.pgo

# View execution trace
make trace                    # Requires gotraceui
```

### Benchmarking Against Other Tools

```bash
make benchmark                # Compares gdu with dua, duc, ncdu, diskus, du, dust, pdu
```

### Release

```bash
# Create release (requires gh CLI and GPG)
make all                      # Builds everything, generates checksums
make release                  # Creates GitHub release with VERSION tag
```

## Configuration

Gdu uses YAML configuration files located at:
- `$HOME/.config/gdu/gdu.yaml` (preferred)
- `$HOME/.gdu.yaml` (fallback)

Generate a default config:
```bash
gdu --write-config
```

See `configuration.md` for all available options.

## Code Conventions

- **Go version**: 1.23+ (see go.mod)
- **Line length**: Max 160 characters (golangci-lint)
- **Linters**: Extensive linting with golangci-lint (see `.golangci.yml`)
- **Build flags**: Uses PGO (Profile-Guided Optimization) via `default.pgo`
- **Platform-specific code**: Use build tags, name files as `*_linux.go`, `*_darwin.go`, etc.
- **Error shadowing**: Allowed (see exclude rules in `.golangci.yml`)
- **Test files**: Relaxed linting rules for `*_test.go` files
- **Commit messages**: NEVER include "Generated by Claude Code" or similar AI attributions in commit messages or code
- **Working on tasks/phases**: Always use appropriate agents for the task, eg. Software, QA, and other engineers. Project Manager agent shold never code or code revie. He should only manage other agents and update tracking document.


## Module Structure

The project uses Go modules with the base path `github.com/dundee/gdu/v5`.

### Key Interfaces

**Analyzer** (`pkg/analyze/`): Core interface for disk analysis with multiple implementations:
- `ParallelAnalyzer` - Default, uses goroutines for parallel traversal
- `SequentialAnalyzer` - For HDDs (--sequential flag)
- `StoredAnalyzer` - Persistent storage backend using BadgerDB (experimental)

**UI** (`cmd/gdu/app/app.go`): Common interface for both TUI and text output modes

**Item** (`pkg/fs/`): Represents a file or directory in the filesystem tree

## Testing Strategy

- Unit tests for all packages (`*_test.go`)
- Platform-specific tests (`*_linux_test.go`, `*_bsd_test.go`)
- Test utilities in `internal/testanalyze`, `internal/testapp`, etc.
- CI runs tests on multiple Go versions (1.23.x, 1.24.x, 1.25.x) and platforms (ubuntu, macos)

## GitHub Actions

- **test.yml**: Runs linting, tests on multiple Go versions/platforms, and coverage
- **docker.yml**: Builds and publishes Docker images
- **codeql-analysis.yml**: Security scanning
- **winget.yml**: Windows package management

## Memory Management

Gdu implements automatic GC balancing:
- Disables GC during analysis when sufficient free memory is available
- Enables GC with adaptive frequency when memory is constrained
- Manual control via `--const-gc` flag with `GOGC` environment variable

## Storage Modes

Two main storage approaches:
1. **In-memory** (default): Fast, higher memory usage
2. **Persistent storage** (experimental): Uses BadgerDB, ~10x slower but much lower memory usage

Enable with: `GOGC=10 gdu -g --use-storage /path`

## Planned Features

### Incremental Caching (In Development)

A new incremental caching feature is planned to address performance issues when scanning NFS/DDN storage systems. This feature will:

- **Reduce I/O by 90%+**: Only re-scan directories that have changed (based on mtime)
- **Cache management**: Configurable cache expiry and I/O throttling
- **Gentle on storage**: Rate limiting options for shared NFS environments
- **Backward compatible**: New `--incremental` flag, doesn't affect existing features

**Detailed Implementation Plan**: See `docs/incremental-caching-implementation-plan.md`

**Key flags** (planned):
```bash
gdu --incremental /mnt/nfs/data              # Enable incremental mode
gdu --incremental --cache-max-age 24h /path  # Cache expires after 24h
gdu --incremental --max-iops 1000 /path      # Limit I/O operations
gdu --incremental --show-cache-stats /path   # Show cache statistics
```

**Use case**: Daily disk usage analysis on large NFS volumes without overloading the storage system.
